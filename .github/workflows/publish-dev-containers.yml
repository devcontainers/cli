name: Publish @devcontainers/cli

on:
  push:
    tags:
      - 'v*'

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        persist-credentials: false
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '14.x'
        registry-url: 'https://registry.npmjs.org'
        scope: '@devcontainers'
    - name: Verify Versions
      run: |
        node -e "
          const packageRef = 'refs/tags/v' + require('./package.json').version;
          const githubRef = '${{ github.ref }}';
          if (packageRef !== githubRef && packageRef + '-pre-release' != githubRef) {
            console.log('::error::' + 'Version Mismatch.', packageRef, githubRef);
            throw Error('Version Mismatch');
          }
        "
    - name: Env
      run: |
        TAG="${{ github.ref }}";
        TAG="${TAG#refs/tags/}";
        echo "TAG=${TAG}" >> $GITHUB_ENV;
        VER=$(cat package.json | jq -r '.version')
        echo "VER=${VER}" >> $GITHUB_ENV;
    - name: Download Artifacts
      uses: dawidd6/action-download-artifact@6f8f427fb41886a66b82ea11a5a15d1454c79415
      with:
        workflow: dev-containers.yml
        workflow_conclusion: success
        commit: ${{ github.sha }}
    - name: Publish package
      run: npm publish devcontainers-cli-${VER}.tgz --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    - name: Create GitHub release
      uses: softprops/action-gh-release@v1
      with:
        body_path: CHANGELOG.txt
        tag_name: ${{ env.TAG }}
        repository: ${{ github.repository }}
        files: |
          devcontainers-cli-${{ env.VER }}.tgz
          devcontainer-linux-x64
          devcontainer-linux-arm64
          devcontainer-macos-x64
          devcontainer-macos-arm64
          devcontainer-win-x64.exe
          devcontainer-win-arm64.exe
